<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Bookmarklet Dolibarr - Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 0;
        }
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 40px;
            margin-bottom: 30px;
        }
        .bookmarklet-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: bold;
            font-size: 18px;
            display: inline-block;
            cursor: move;
            margin: 10px;
        }
        .bookmarklet-btn:hover {
            color: white;
            transform: scale(1.05);
        }
        .debug-btn {
            background: #dc3545;
        }
        code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            color: #e83e8c;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-4">
            <h1 class="text-white">
                <i class="bi bi-bookmark-star"></i> 
                Test Bookmarklet Dolibarr
            </h1>
        </div>

        <div class="card">
            <h3 class="mb-4">üêõ Version DEBUG (√† tester en premier)</h3>
            <p>Ce bookmarklet affiche des messages dans la console pour comprendre ce qui se passe.</p>
            
            <div class="text-center mb-4">
                <a href="javascript:(function(){console.log('=== BOOKMARKLET START ===');alert('‚úÖ Le bookmarklet fonctionne!\\n\\nRegardez la console (F12) pour voir les d√©tails.');var d={societe:'',numero_commande:'',numero_devis:'',date_commande:'',delai_fabrication:'',reference_article:'',quantite:''};try{console.log('1. Extraction soci√©t√©...');var s=document.querySelector('.refidno a[href*=&quot;societe&quot;]');if(s){d.societe=s.textContent.trim();console.log('‚úÖ Soci√©t√©:',d.societe);}else{console.warn('‚ùå Soci√©t√© non trouv√©e');}console.log('2. Extraction num√©ro commande...');var n=document.querySelector('.refid.refidpadding');if(n){d.numero_commande=n.childNodes[0].textContent.trim();console.log('‚úÖ Num√©ro commande:',d.numero_commande);}else{console.warn('‚ùå Num√©ro commande non trouv√©');}console.log('3. Extraction num√©ro devis...');var p=document.querySelector('a[href*=&quot;propal&quot;]');if(p){var m=p.textContent.match(/PR\d+-\d+/);if(m){d.numero_devis=m[0];console.log('‚úÖ Num√©ro devis:',d.numero_devis);}}else{console.warn('‚ö†Ô∏è Devis non trouv√© (peut √™tre normal)');}console.log('4. Extraction date...');var rows=document.querySelectorAll('tr');for(var i=0;i<rows.length;i++){var cells=rows[i].querySelectorAll('td');if(cells.length>=2){var label=cells[0].textContent.trim();if(label==='Date'){var dateText=cells[1].textContent.trim();var match=dateText.match(/(\d{2})\/(\d{2})\/(\d{4})/);if(match){d.date_commande=match[3]+'-'+match[2]+'-'+match[1];console.log('‚úÖ Date:',d.date_commande);}}if(label.includes('livraison')||label.includes('fabrication')){var val=cells[1].querySelector('.valuefield');if(val){d.delai_fabrication=val.textContent.trim();console.log('‚úÖ D√©lai:',d.delai_fabrication);}}}}console.log('5. Extraction r√©f√©rence...');var ref=document.querySelector('a[href*=&quot;product&quot;]');if(ref){d.reference_article=ref.textContent.trim();console.log('‚úÖ R√©f√©rence:',d.reference_article);}else{console.warn('‚ö†Ô∏è R√©f√©rence non trouv√©e');}console.log('6. Extraction quantit√©...');var qty=document.querySelector('.linecolqty');if(qty){d.quantite=qty.textContent.trim().replace(/\s/g,'');console.log('‚úÖ Quantit√©:',d.quantite);}else{console.warn('‚ö†Ô∏è Quantit√© non trouv√©e');}console.log('7. DONN√âES EXTRAITES:',d);if(!d.numero_commande&&!d.societe){alert('‚ùå ERREUR\\n\\nAucune donn√©e n\\'a pu √™tre extraite.\\n\\nV√©rifiez:\\n- Vous √™tes sur une COMMANDE CLIENT\\n- La page est compl√®tement charg√©e\\n\\nRegardez la console (F12) pour les d√©tails.');console.error('Erreur: Aucune donn√©e extraite');return;}alert('‚úÖ EXTRACTION R√âUSSIE!\\n\\nDonn√©es trouv√©es:\\n\\nSoci√©t√©: '+d.societe+'\\nCommande: '+d.numero_commande+'\\nDevis: '+d.numero_devis+'\\n\\nUn nouvel onglet va s\\'ouvrir...');console.log('8. Sauvegarde sessionStorage...');sessionStorage.setItem('dolibarr_import_data',JSON.stringify(d));console.log('9. Ouverture application...');var baseUrl=prompt('Entrez l\\'URL de votre application Gestion Commandes:\\n(ex: http://localhost/gestion-commandes)','http://localhost/gestion-commandes');if(baseUrl){var url=baseUrl+'/nouvelle-commande.php';console.log('URL:',url);var win=window.open(url,'_blank');if(!win){alert('‚ö†Ô∏è Popup bloqu√©!\\n\\nAutorisez les popups pour ce site.');}else{console.log('‚úÖ Fen√™tre ouverte');}}console.log('=== BOOKMARKLET END ===');}catch(e){console.error('‚ùå ERREUR:',e);alert('‚ùå ERREUR\\n\\n'+e.message+'\\n\\nRegardez la console (F12)');}})()" 
                   class="bookmarklet-btn debug-btn"
                   onclick="return false;">
                    üêõ TEST DEBUG - Glissez-moi dans vos favoris
                </a>
            </div>
            
            <div class="alert alert-warning">
                <h6>‚ö†Ô∏è Important : Ce bookmarklet de test va :</h6>
                <ol>
                    <li>Afficher un message au d√©marrage</li>
                    <li>Afficher tous les logs dans la console</li>
                    <li>Afficher les donn√©es extraites</li>
                    <li>Vous demander l'URL de votre application</li>
                </ol>
            </div>
        </div>

        <div class="card">
            <h3 class="mb-4">üìã Comment tester ?</h3>
            
            <div class="row">
                <div class="col-md-6">
                    <h5>1Ô∏è‚É£ Installation</h5>
                    <ol>
                        <li>Affiche ta barre de favoris (<code>Ctrl+Shift+B</code>)</li>
                        <li><strong>Glisse</strong> le bouton rouge dans tes favoris</li>
                    </ol>
                </div>
                
                <div class="col-md-6">
                    <h5>2Ô∏è‚É£ Utilisation</h5>
                    <ol>
                        <li>Va sur une <strong>commande Dolibarr</strong></li>
                        <li>Ouvre la console (<code>F12</code>)</li>
                        <li>Clique sur le bookmarklet</li>
                        <li>Regarde les messages !</li>
                    </ol>
                </div>
            </div>
            
            <hr>
            
            <h5>3Ô∏è‚É£ Que regarder dans la console ?</h5>
            <div class="alert alert-info">
                <p class="mb-2">La console doit afficher :</p>
                <pre class="mb-0" style="background: #f8f9fa; padding: 10px; border-radius: 5px;">
=== BOOKMARKLET START ===
‚úÖ Soci√©t√©: Mme Patricia Paul
‚úÖ Num√©ro commande: CO2602-4359
‚úÖ Num√©ro devis: PR2602-4076
...
=== BOOKMARKLET END ===</pre>
            </div>
        </div>

        <div class="card">
            <h3 class="mb-4">üö® Probl√®mes courants</h3>
            
            <div class="accordion" id="faqAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                            Le bookmarklet ne fait RIEN (pas de message)
                        </button>
                    </h2>
                    <div id="faq1" class="accordion-collapse collapse show">
                        <div class="accordion-body">
                            <strong>Causes possibles :</strong>
                            <ul>
                                <li>‚ùå Le bookmarklet n'est pas bien install√© (c'est un lien normal, pas un bookmarklet)</li>
                                <li>‚ùå JavaScript est d√©sactiv√©</li>
                                <li>‚ùå Une extension bloque les bookmarklets</li>
                            </ul>
                            <strong>Solution :</strong>
                            <ol>
                                <li>Clic droit sur le bookmarklet ‚Üí Modifier</li>
                                <li>V√©rifie que l'URL commence par <code>javascript:(function()</code></li>
                                <li>Si elle commence par <code>http://</code> ‚Üí Ce n'est PAS un bookmarklet ‚ùå</li>
                            </ol>
                        </div>
                    </div>
                </div>
                
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                            Message "Aucune donn√©e extraite"
                        </button>
                    </h2>
                    <div id="faq2" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <strong>Causes :</strong>
                            <ul>
                                <li>‚ùå Vous n'√™tes pas sur une page de COMMANDE CLIENT</li>
                                <li>‚ùå Vous √™tes sur un devis, une facture, ou autre chose</li>
                                <li>‚ùå La structure HTML de votre Dolibarr est diff√©rente</li>
                            </ul>
                            <strong>Solution :</strong>
                            <p>V√©rifiez dans la console QUELLES donn√©es sont trouv√©es et lesquelles ne le sont pas.</p>
                        </div>
                    </div>
                </div>
                
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                            Le popup ne s'ouvre pas
                        </button>
                    </h2>
                    <div id="faq3" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <strong>Cause :</strong> Les popups sont bloqu√©s
                            <br>
                            <strong>Solution :</strong> Autorise les popups pour Dolibarr dans les param√®tres du navigateur
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center text-white mt-4">
            <p><a href="nouvelle-commande.php" class="text-white">‚Üê Retour au formulaire</a></p>
            <p><a href="dolibarr-bookmarklet.html" class="text-white">‚Üí Version normale du bookmarklet</a></p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
